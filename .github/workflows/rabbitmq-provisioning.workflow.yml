name: 'RabbitMQ - Platform Service Operations'

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - production
      action:
        description: 'Action to perform'
        required: true
        default: 'sync'
        type: choice
        options:
          - sync
          - upgrade
          - restart
          - uninstall

env:
  SERVICE_NAME: rabbitmq
  NAMESPACE: rabbitmq
  HELM_RELEASE_NAME: rabbitmq
  HELM_REPO_NAME: bitnami
  HELM_REPO_URL: https://charts.bitnami.com/bitnami
  HELM_CHART_NAME: bitnami/rabbitmq

jobs:
  set-environment:
    name: 'Set Environment'
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      action: ${{ steps.set-action.outputs.action }}
    steps:
      - name: Set environment
        id: set-env
        run: |
          echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          echo "Environment: ${{ github.event.inputs.environment }}"

      - name: Set action
        id: set-action
        run: |
          echo "action=${{ github.event.inputs.action }}" >> $GITHUB_OUTPUT
          echo "Action: ${{ github.event.inputs.action }}"

  operate:
    name: 'RabbitMQ Operations (${{ needs.set-environment.outputs.environment }})'
    runs-on: self-hosted
    needs: set-environment
    environment: ${{ needs.set-environment.outputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set environment variables
        id: env-vars
        run: |
          ENV="${{ needs.set-environment.outputs.environment }}"
          ENV_SHORT=$(echo "$ENV" | cut -d'-' -f1)
          echo "env_short=${ENV_SHORT}" >> $GITHUB_OUTPUT
          echo "server=argocd.${ENV}.wapps.com" >> $GITHUB_OUTPUT

      - name: Install ArgoCD CLI
        if: needs.set-environment.outputs.action != 'uninstall'
        run: |
          if ! command -v argocd &> /dev/null; then
            curl -sSL -o argocd-linux-amd64 https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
            chmod +x argocd-linux-amd64
            mkdir -p $HOME/.local/bin
            mv argocd-linux-amd64 $HOME/.local/bin/argocd
            echo "$HOME/.local/bin" >> $GITHUB_PATH
          fi

      - name: Login to ArgoCD
        if: needs.set-environment.outputs.action != 'uninstall'
        run: |
          argocd login ${{ steps.env-vars.outputs.server }} \
            --username ${{ secrets.ARGO_INITIAL_USERNAME }} \
            --password ${{ secrets.ARGO_INITIAL_PASSWORD }} \
            --insecure --grpc-web

      - name: Sync RabbitMQ via ArgoCD
        if: needs.set-environment.outputs.action == 'sync'
        run: |
          echo "Syncing RabbitMQ via ArgoCD..."
          argocd app sync ${{ env.SERVICE_NAME }} --grpc-web
          argocd app wait ${{ env.SERVICE_NAME }} --timeout 300 --grpc-web || true
          echo "✅ RabbitMQ synced"

      - name: Upgrade RabbitMQ Helm Chart
        if: needs.set-environment.outputs.action == 'upgrade'
        run: |
          echo "Upgrading RabbitMQ Helm chart..."
          helm repo add ${{ env.HELM_REPO_NAME }} ${{ env.HELM_REPO_URL }}
          helm repo update
          
          helm upgrade ${{ env.HELM_RELEASE_NAME }} ${{ env.HELM_CHART_NAME }} \
            --namespace ${{ env.NAMESPACE }} \
            --values platform/cluster/rabbitmq/values.yaml \
            --set auth.username="${{ secrets.RABBITMQ_USERNAME }}" \
            --set auth.password="${{ secrets.RABBITMQ_PASSWORD }}" \
            --set auth.erlangCookie="${{ secrets.RABBITMQ_ERLANG_COOKIE }}" \
            --wait \
            --timeout 10m
          
          echo "✅ RabbitMQ upgraded - syncing with ArgoCD..."
          argocd login ${{ steps.env-vars.outputs.server }} \
            --username ${{ secrets.ARGO_INITIAL_USERNAME }} \
            --password ${{ secrets.ARGO_INITIAL_PASSWORD }} \
            --insecure --grpc-web
          argocd app sync ${{ env.SERVICE_NAME }} --grpc-web || true

      - name: Restart RabbitMQ
        if: needs.set-environment.outputs.action == 'restart'
        run: |
          echo "Restarting RabbitMQ pods..."
          kubectl rollout restart statefulset/${{ env.HELM_RELEASE_NAME }} -n ${{ env.NAMESPACE }}
          kubectl rollout status statefulset/${{ env.HELM_RELEASE_NAME }} -n ${{ env.NAMESPACE }} --timeout=300s
          echo "✅ RabbitMQ restarted"

      - name: Uninstall RabbitMQ
        if: needs.set-environment.outputs.action == 'uninstall'
        run: |
          echo "⚠️ Uninstalling RabbitMQ..."
          kubectl delete application ${{ env.SERVICE_NAME }} -n argocd || true
          helm uninstall ${{ env.HELM_RELEASE_NAME }} --namespace ${{ env.NAMESPACE }} || true
          echo "✅ RabbitMQ uninstalled"
          echo "⚠️ Note: PVCs and namespace are not deleted automatically"

      - name: Verify RabbitMQ status
        if: needs.set-environment.outputs.action != 'uninstall'
        run: |
          echo "Verifying RabbitMQ status..."
          kubectl get pods -n ${{ env.NAMESPACE }} -l app.kubernetes.io/name=rabbitmq
          kubectl get svc -n ${{ env.NAMESPACE }}
          argocd app get ${{ env.SERVICE_NAME }} --grpc-web || true
          echo "✅ Status check complete"

  summary:
    name: 'Operation Summary'
    runs-on: ubuntu-latest
    needs: [set-environment, operate]
    if: always()
    steps:
      - name: Print summary
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "RabbitMQ - Platform Service Operations Summary"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "Environment: ${{ needs.set-environment.outputs.environment }}"
          echo "Action: ${{ needs.set-environment.outputs.action }}"
          echo ""
          echo "Job Results:"
          echo "  - Operation: ${{ needs.operate.result }}"
          echo ""
          
          if [ "${{ needs.operate.result }}" == "success" ]; then
            echo "✅ Operation completed successfully!"
            
            if [ "${{ needs.set-environment.outputs.action }}" == "sync" ]; then
              echo ""
              echo "Service endpoints:"
              echo "  - AMQP: amqp://rabbitmq.rabbitmq:5672"
              echo "  - Management UI: https://rabbitmq.${{ needs.set-environment.outputs.environment }}.wapps.com"
              echo ""
              echo "Connection from pods:"
              echo "  Use secret: rabbitmq-credentials"
            fi
          else
            echo "⚠️ Operation completed with issues. Check logs above."
          fi
          echo ""
          echo "Note: Initial RabbitMQ installation is handled by platform/host/main.yml"
          echo "This workflow is for day-2 operations only (sync, upgrade, restart, uninstall)"
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

