name: 'RabbitMQ - Platform Service Provisioning'

on:
  push:
    branches: [develop, main]
    paths:
      - 'platform/cluster/rabbitmq/**'
      - 'environments/dev/platform/rabbitmq-kustomization/**'
      - '.github/workflows/rabbitmq-provisioning.workflow.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - production
      action:
        description: 'Action to perform'
        required: true
        default: 'install'
        type: choice
        options:
          - install
          - upgrade
          - sync
          - uninstall

env:
  SERVICE_NAME: rabbitmq
  NAMESPACE: rabbitmq
  HELM_RELEASE_NAME: rabbitmq
  HELM_REPO_NAME: bitnami
  HELM_REPO_URL: https://charts.bitnami.com/bitnami
  HELM_CHART_NAME: bitnami/rabbitmq

jobs:
  set-environment:
    name: 'Set Environment'
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      action: ${{ steps.set-action.outputs.action }}
    steps:
      - name: Set environment
        id: set-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV="${{ github.event.inputs.environment }}"
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            ENV="production"
          else
            ENV="development"
          fi
          echo "environment=${ENV}" >> $GITHUB_OUTPUT
          echo "Environment: ${ENV}"

      - name: Set action
        id: set-action
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ACTION="${{ github.event.inputs.action }}"
          else
            ACTION="sync"
          fi
          echo "action=${ACTION}" >> $GITHUB_OUTPUT
          echo "Action: ${ACTION}"

  provision:
    name: 'Provision RabbitMQ (${{ needs.set-environment.outputs.environment }})'
    runs-on: self-hosted
    needs: set-environment
    environment: ${{ needs.set-environment.outputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set environment variables
        id: env-vars
        run: |
          ENV="${{ needs.set-environment.outputs.environment }}"
          ENV_SHORT=$(echo "$ENV" | cut -d'-' -f1)
          echo "env_short=${ENV_SHORT}" >> $GITHUB_OUTPUT
          echo "server=argocd.${ENV}.wapps.com" >> $GITHUB_OUTPUT

      - name: Create namespace
        run: |
          kubectl create namespace ${{ env.NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -
          echo "✅ Namespace ${{ env.NAMESPACE }} ensured"

      - name: Create RabbitMQ secrets
        run: |
          RABBITMQ_USERNAME="${{ secrets.RABBITMQ_USERNAME }}"
          RABBITMQ_PASSWORD="${{ secrets.RABBITMQ_PASSWORD }}"
          RABBITMQ_ERLANG_COOKIE="${{ secrets.RABBITMQ_ERLANG_COOKIE }}"
          
          if [ -z "$RABBITMQ_USERNAME" ] || [ -z "$RABBITMQ_PASSWORD" ] || [ -z "$RABBITMQ_ERLANG_COOKIE" ]; then
            echo "::error::RabbitMQ credentials not configured in GitHub Secrets"
            exit 1
          fi
          
          kubectl create secret generic rabbitmq-credentials \
            --from-literal=host="rabbitmq.rabbitmq" \
            --from-literal=port="5672" \
            --from-literal=username="${RABBITMQ_USERNAME}" \
            --from-literal=password="${RABBITMQ_PASSWORD}" \
            --from-literal=management-port="15672" \
            --from-literal=connection-string="amqp://${RABBITMQ_USERNAME}:${RABBITMQ_PASSWORD}@rabbitmq.rabbitmq:5672/" \
            --namespace=${{ env.NAMESPACE }} \
            --dry-run=client -o yaml | kubectl apply -f -
          
          echo "✅ RabbitMQ credentials secret created/updated"

      - name: Add Helm repository
        if: needs.set-environment.outputs.action == 'install' || needs.set-environment.outputs.action == 'upgrade'
        run: |
          helm repo add ${{ env.HELM_REPO_NAME }} ${{ env.HELM_REPO_URL }}
          helm repo update
          echo "✅ Helm repository added and updated"

      - name: Install RabbitMQ
        if: needs.set-environment.outputs.action == 'install'
        run: |
          echo "Installing RabbitMQ via Helm..."
          
          if helm list -n ${{ env.NAMESPACE }} | grep -q ${{ env.HELM_RELEASE_NAME }}; then
            echo "⚠️ RabbitMQ is already installed. Use 'upgrade' action to update."
            exit 0
          fi
          
          helm install ${{ env.HELM_RELEASE_NAME }} ${{ env.HELM_CHART_NAME }} \
            --namespace ${{ env.NAMESPACE }} \
            --values platform/cluster/rabbitmq/values.yaml \
            --set auth.username="${{ secrets.RABBITMQ_USERNAME }}" \
            --set auth.password="${{ secrets.RABBITMQ_PASSWORD }}" \
            --set auth.erlangCookie="${{ secrets.RABBITMQ_ERLANG_COOKIE }}" \
            --wait \
            --timeout 10m
          
          echo "✅ RabbitMQ installed successfully"

      - name: Upgrade RabbitMQ
        if: needs.set-environment.outputs.action == 'upgrade'
        run: |
          echo "Upgrading RabbitMQ via Helm..."
          
          helm upgrade ${{ env.HELM_RELEASE_NAME }} ${{ env.HELM_CHART_NAME }} \
            --namespace ${{ env.NAMESPACE }} \
            --values platform/cluster/rabbitmq/values.yaml \
            --set auth.username="${{ secrets.RABBITMQ_USERNAME }}" \
            --set auth.password="${{ secrets.RABBITMQ_PASSWORD }}" \
            --set auth.erlangCookie="${{ secrets.RABBITMQ_ERLANG_COOKIE }}" \
            --wait \
            --timeout 10m
          
          echo "✅ RabbitMQ upgraded successfully"

      - name: Uninstall RabbitMQ
        if: needs.set-environment.outputs.action == 'uninstall'
        run: |
          echo "⚠️ Uninstalling RabbitMQ..."
          helm uninstall ${{ env.HELM_RELEASE_NAME }} --namespace ${{ env.NAMESPACE }} || true
          echo "✅ RabbitMQ uninstalled"
          echo "⚠️ Note: PVCs are not deleted automatically"

      - name: Wait for RabbitMQ to be ready
        if: needs.set-environment.outputs.action != 'uninstall'
        run: |
          echo "Waiting for RabbitMQ to be ready..."
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=rabbitmq \
            -n ${{ env.NAMESPACE }} \
            --timeout=300s || true
          echo "✅ RabbitMQ pods checked"

      - name: Verify RabbitMQ installation
        if: needs.set-environment.outputs.action != 'uninstall'
        run: |
          echo "Verifying RabbitMQ installation..."
          kubectl get pods -n ${{ env.NAMESPACE }} -l app.kubernetes.io/name=rabbitmq
          kubectl get svc -n ${{ env.NAMESPACE }}
          kubectl get secret rabbitmq-credentials -n ${{ env.NAMESPACE }}
          echo "✅ RabbitMQ verification complete"

      - name: Install ArgoCD CLI
        if: needs.set-environment.outputs.action != 'uninstall'
        run: |
          if ! command -v argocd &> /dev/null; then
            curl -sSL -o argocd-linux-amd64 https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
            chmod +x argocd-linux-amd64
            mkdir -p $HOME/.local/bin
            mv argocd-linux-amd64 $HOME/.local/bin/argocd
            echo "$HOME/.local/bin" >> $PATH
          fi

      - name: Login to ArgoCD
        if: needs.set-environment.outputs.action != 'uninstall'
        run: |
          argocd login ${{ steps.env-vars.outputs.server }} \
            --username ${{ secrets.ARGO_INITIAL_USERNAME }} \
            --password ${{ secrets.ARGO_INITIAL_PASSWORD }} \
            --insecure --grpc-web

      - name: Create/Sync ArgoCD Application
        if: needs.set-environment.outputs.action != 'uninstall'
        run: |
          if argocd app get ${{ env.SERVICE_NAME }} --grpc-web 2>/dev/null; then
            echo "ArgoCD application exists, syncing..."
            argocd app sync ${{ env.SERVICE_NAME }} --grpc-web
          else
            echo "Creating ArgoCD application..."
            kubectl apply -f argocd/applications/platform/${{ env.SERVICE_NAME }}.yaml
            sleep 5
            argocd app sync ${{ env.SERVICE_NAME }} --grpc-web || true
          fi
          
          echo "Waiting for sync to complete..."
          argocd app wait ${{ env.SERVICE_NAME }} --timeout 300 --grpc-web || true
          echo "✅ ArgoCD sync completed"

      - name: Apply environment configuration
        if: needs.set-environment.outputs.action != 'uninstall'
        run: |
          ENV_SHORT="${{ steps.env-vars.outputs.env_short }}"
          
          if [ -d "environments/${ENV_SHORT}/platform/rabbitmq-kustomization" ]; then
            kubectl apply -k environments/${ENV_SHORT}/platform/rabbitmq-kustomization/
            echo "✅ Environment configuration applied"
          else
            echo "⚠️ No environment overlay found"
          fi

      - name: Apply network policies
        if: needs.set-environment.outputs.action != 'uninstall'
        run: |
          ENV_SHORT="${{ steps.env-vars.outputs.env_short }}"
          
          if [ -f "environments/${ENV_SHORT}/platform/backend-network-policies.yaml" ]; then
            kubectl apply -f environments/${ENV_SHORT}/platform/backend-network-policies.yaml
            echo "✅ Network policies applied"
          fi

  summary:
    name: 'Deployment Summary'
    runs-on: ubuntu-latest
    needs: [set-environment, provision]
    if: always()
    steps:
      - name: Print summary
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "RabbitMQ - Platform Service Provisioning Summary"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "Environment: ${{ needs.set-environment.outputs.environment }}"
          echo "Action: ${{ needs.set-environment.outputs.action }}"
          echo ""
          echo "Job Results:"
          echo "  - Provision: ${{ needs.provision.result }}"
          echo ""
          
          if [ "${{ needs.provision.result }}" == "success" ] && [ "${{ needs.set-environment.outputs.action }}" != "uninstall" ]; then
            echo "✅ RabbitMQ provisioned successfully!"
            echo ""
            echo "Service endpoints:"
            echo "  - AMQP: amqp://rabbitmq.rabbitmq:5672"
            echo "  - Management UI: https://rabbitmq.${{ needs.set-environment.outputs.environment }}.wapps.com"
            echo ""
            echo "Connection from pods:"
            echo "  Use secret: rabbitmq-credentials"
          elif [ "${{ needs.set-environment.outputs.action }}" == "uninstall" ]; then
            echo "✅ RabbitMQ uninstalled successfully!"
          else
            echo "⚠️ Provisioning completed with issues. Check logs above."
          fi
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

