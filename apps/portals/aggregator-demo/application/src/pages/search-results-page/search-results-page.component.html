<section class="section__breadcrumbs">
  @let breadcrumbs = breadcrumbs$ | async;
  <ui-breadcrumbs [breadcrumbs]="breadcrumbs || []"></ui-breadcrumbs>
</section>

<section class="section__filters">
  <filters-bar></filters-bar>
</section>

@let resultsData = resultsData$ | async;
@if (resultsData && !resultsData.isLoading) {
  @for (group of resultsData.groups; track group.type) {
    @let label = getGroupLabel(group.type);
    <ui-titled-separator 
      [text]="label.value" 
      [icon]="label.icon">
    </ui-titled-separator>
    <section
      commonSection
      class="section__results" 
      [id]="group.type"
      (appIntersect)="onVisibilityChange($event.isVisible, $event.element, group)">
      @for (entry of group.entries; track entry.name) {
        @switch (group.type) {
          @case (DiscoverySearchResultType.Article) {
            <ng-container *ngTemplateOutlet="articleEntry; context: { entry }"></ng-container>
          }
          @case (DiscoverySearchResultType.Application) {
            <ng-container *ngTemplateOutlet="applicationEntry; context: { entry }"></ng-container>
          }
          @case (DiscoverySearchResultType.Suite) {
            <ng-container *ngTemplateOutlet="suiteEntry; context: { entry }"></ng-container>
          }
        }
      }
      <button
        class="show-all-results-button"
        slot="footer"
        tuiButton 
        appearance="primary" 
        size="s">
          Show all results ({{ group.entries.length }}) 
          <tui-icon icon="@tui.chevron-right"></tui-icon>
      </button>
    </section>
  }
}
@else {
  @for (groupType of [
    DiscoverySearchResultType.Suite, 
    DiscoverySearchResultType.Article,
  ]; track groupType) {
    <ui-titled-separator text="Loading"></ui-titled-separator>
    <section 
      class="section__results" 
      commonSection>
      @for (entry of [1, 2, 3]; track entry) {
        @switch (groupType) {
          @case (DiscoverySearchResultType.Article) {
            <ng-container *ngTemplateOutlet="articleEntrySkeleton;"></ng-container>
          }
          @case (DiscoverySearchResultType.Application) {
            <ng-container *ngTemplateOutlet="applicationEntrySkeleton;"></ng-container>
          }
          @case (DiscoverySearchResultType.Suite) {
            <ng-container *ngTemplateOutlet="suiteEntrySkeleton;"></ng-container>
          }
        }
      }
    </section>
  }
}

<ng-template #articleEntry let-entry="entry">
  @let vm = toArticleVM(entry);
  <ui-elevated-card>
    <ui-cover-image [image]="vm.coverImageUrl" slot="backdrop"/>
    <ui-medium-card>
      <article-rating [readonly]="true" slot="actions" [rating]="vm.rating"/>
      <h3 uiMediumTitle slot="title">{{ vm.title }}</h3>
      <ui-tags [tags]="vm.tags" slot="tags"></ui-tags>
      <ui-excerpt [excerpt]="vm.excerpt" slot="excerpt"></ui-excerpt>
      <article-author-info [author]="vm.author" slot="author">
        <profile-badges [badges]="vm.authorBadges" slot="badges"></profile-badges>
      </article-author-info>
    </ui-medium-card>
  </ui-elevated-card>
</ng-template>


<ng-template #articleEntrySkeleton>
  <ui-elevated-card-skeleton>
    <article-rating-skeleton slot="top-bar"></article-rating-skeleton>
    <ui-medium-title-skeleton/>
    <ui-tags-skeleton/>
    <ui-excerpt-skeleton/>
    <article-author-info-skeleton/>
  </ui-elevated-card-skeleton>
</ng-template>




<ng-template #applicationEntry let-entry="entry">
  @let vm = toApplicationVM(entry);
  <ui-medium-card>
    <my-favorite-toggle [readonly]="true" slot="top-bar" [item]="vm"/>
    <ui-card-header>
      <app-avatar slot="left-side" [avatar]="vm.avatarUrl"/>
      <h3 uiMediumTitle>
        {{ vm.title }}
        <app-rating [readonly]="true" [rating]="vm.rating"/>
      </h3>
      <ui-tags [tags]="vm.tags"></ui-tags>
    </ui-card-header>
    <app-voting-chip slot="bottom-bar" [voting]="vm.voting"></app-voting-chip>
    <discussion-chip slot="bottom-bar" [commentsCount]="vm.commentsNumber"></discussion-chip>
    @if (vm.topReview) {
      <top-review-card [review]="vm.topReview">
        <profile-badges [badges]="vm.topReview.authorBadges"></profile-badges>
      </top-review-card>
    }
  </ui-medium-card>
</ng-template>


<ng-template #applicationEntrySkeleton>
  <ui-elevated-card-skeleton>
    <article-rating-skeleton slot="top-bar"></article-rating-skeleton>
    <ui-medium-title-skeleton/>
    <ui-tags-skeleton/>
    <ui-excerpt-skeleton/>
    <article-author-info-skeleton/>
  </ui-elevated-card-skeleton>
</ng-template>



<ng-template #suiteEntry let-entry="entry">
  @let vm = toSuiteVM(entry);
  <ui-medium-card>
    <my-favorite-toggle [readonly]="true" slot="top-bar" [item]="vm"/>
    <h3 uiMediumTitle>
      {{ vm.title }}
      <app-rating [readonly]="true" [rating]="vm.rating"/>
    </h3>
    <ui-tags [tags]="vm.tags"></ui-tags>
    <suite-app-avatars [apps]="vm.applications"></suite-app-avatars>
    <app-voting-chip slot="bottom-bar" [voting]="vm.voting"></app-voting-chip>
    <discussion-chip slot="bottom-bar" [commentsCount]="vm.commentsNumber"></discussion-chip>
    @if (vm.topReview) {
      <top-review-card [review]="vm.topReview">
        <profile-badges [badges]="vm.topReview.authorBadges"></profile-badges>
      </top-review-card>
    }
  </ui-medium-card>
</ng-template>


<ng-template #suiteEntrySkeleton>
  <ui-elevated-card-skeleton>
    <article-rating-skeleton slot="top-bar"></article-rating-skeleton>
    <ui-medium-title-skeleton/>
    <ui-tags-skeleton/>
    <ui-excerpt-skeleton/>
    <article-author-info-skeleton/>
  </ui-elevated-card-skeleton>
</ng-template>





<!-- <suite-result-tile
routerLink=""
class="item-card"
[item]="vm">
<div slot="top-bar">
  <button
    tuiButton
    iconStart="@tui.heart"
    size="s"
    appearance="primary"
    (click)="$event.preventDefault(); $event.stopPropagation(); onSaveSuite(entry)">
  </button>
</div>
<div slot="bottom-bar">
  <tui-chip size="xs" appearance="action-soft">
    <discussion-indicator
      [commentsCount]="entry.commentsNumber"
      (click)="$event.preventDefault(); $event.stopPropagation()">
    </discussion-indicator>
  </tui-chip>
</div>
<div slot="footer">
  @if (vm.topComment) {
    <top-comment
      class="top-comment"
      [comment]="vm.topComment">
      @for (badge of vm.topComment.authorBadges; track badge) {
        <tui-chip
          slot="author-info"
          size="xs"
          [iconStart]="badge.icon"
          [appearance]="badge.appearance">
          {{ badge.name }}
        </tui-chip>
      }
    </top-comment>
  }
</div>
</suite-result-tile>
 -->





<!-- <application-result-tile
  class="item-card"
  [item]="toApplicationVM(entry)">
  <div slot="top-bar">
    <button
      tuiButton
      iconStart="@tui.heart"
      size="s"
      appearance="primary"
      (click)="$event.preventDefault(); $event.stopPropagation(); onSaveApplication(entry)">
    </button>
  </div>
  <div slot="bottom-bar">
    <tui-chip size="xs" appearance="action-soft">
      <discussion-indicator
        [commentsCount]="entry.commentsNumber"
        (click)="$event.preventDefault(); $event.stopPropagation()">
      </discussion-indicator>
    </tui-chip>
  </div>
  <div slot="footer">
    @if (vm.topReview) {
      <top-review
        class="top-comment"
        [review]="vm.topReview">
        @for (badge of vm.topReview.authorBadges; track badge) {
          <tui-chip
            slot="author-info"
            size="xs"
            [iconStart]="badge.icon"
            [appearance]="badge.appearance">
            {{ badge.name }}
          </tui-chip>
        }
      </top-review>
    }
  </div>
</application-result-tile> -->



<!-- 
<article-result-tile
class="item-card blank" 
[item]="vm">
<div slot="top-bar">
  <button
    tuiButton
    iconStart="@tui.heart"
    size="s"
    appearance="primary"
    (click)="$event.preventDefault(); $event.stopPropagation(); onSaveArticle(entry)">
  </button>
</div>
<tui-badge 
  [iconStart]="'@tui.badge-check'"
  slot="user-badges"
  appearance="primary-soft">
  verified
</tui-badge>
<tui-badge  
  [iconStart]="'@tui.rocket'" 
  slot="user-badges"
  appearance="premium-soft">
  premium
</tui-badge>
</article-result-tile> -->