---
# ==============================================
# MongoDB Installation on Host for Kubernetes Cluster
# ==============================================
# This playbook installs MongoDB on the host machine and configures it to be
# accessible from pods running in the Kubernetes cluster.
# It creates a Kubernetes Service with manual Endpoints pointing to the host IP.
#
# Credentials come from Ansible vars:
#   - mongodb_root_password (admin/root user)
#   - mongodb_wapps_username (shared app user username)
#   - mongodb_wapps_password (shared app user password)

- name: Validate host OS is Ubuntu (MongoDB install expects apt)
  assert:
    that:
      - ansible_distribution | lower == 'ubuntu'
    fail_msg: >
      MongoDB host provisioning currently supports Ubuntu only (uses official MongoDB apt repository).
      Detected ansible_distribution={{ ansible_distribution | default('unknown') }}.

- name: Validate required MongoDB credentials are provided
  assert:
    that:
      - (mongodb_root_password | default('', true)) | length > 0
      - (mongodb_wapps_username | default('', true)) | length > 0
      - (mongodb_wapps_password | default('', true)) | length > 0
    fail_msg: >
      Missing MongoDB credentials. Provide non-empty Ansible vars:
      mongodb_root_password, mongodb_wapps_username and mongodb_wapps_password (via GitHub secrets or --extra-vars).

- name: Map Ubuntu codename for MongoDB apt repo
  set_fact:
    # MongoDB's apt repos sometimes lag behind the newest Ubuntu codenames.
    # Keep the value a clean single token (no whitespace/newlines), otherwise the apt source line breaks.
    mongodb_ubuntu_codename: "{{ 'jammy' if (ansible_distribution_release | default('jammy')) in ['noble', 'oracular', 'plucky'] else (ansible_distribution_release | default('jammy')) }}"

# ==============================================
# MongoDB APT repository (Ubuntu)
# ==============================================
- name: Install MongoDB prerequisites
  package:
    name:
      - curl
      - gnupg
      - ca-certificates
    state: present

- name: Add MongoDB 7.0 GPG keyring
  shell: |
    set -e
    curl -fsSL https://pgp.mongodb.com/server-7.0.asc | gpg --dearmor -o /usr/share/keyrings/mongodb-server-7.0.gpg
  args:
    creates: /usr/share/keyrings/mongodb-server-7.0.gpg

- name: Add MongoDB 7.0 APT repository
  copy:
    dest: /etc/apt/sources.list.d/mongodb-org-7.0.list
    mode: '0644'
    content: |
      deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-7.0.gpg ] https://repo.mongodb.org/apt/ubuntu {{ mongodb_ubuntu_codename | trim }}/mongodb-org/7.0 multiverse

- name: Update apt cache (MongoDB repo)
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Display host facts relevant to MongoDB packages
  debug:
    msg:
      - "ansible_distribution={{ ansible_distribution | default('unknown') }}"
      - "ansible_distribution_release={{ ansible_distribution_release | default('unknown') }}"
      - "ansible_architecture={{ ansible_architecture | default('unknown') }}"
      - "ansible_userspace_architecture={{ ansible_userspace_architecture | default('unknown') }}"
      - "mongodb_ubuntu_codename={{ mongodb_ubuntu_codename | default('unset') }}"

- name: Verify MongoDB apt repo exposes mongodb-org package
  shell: |
    set -e
    apt-cache policy mongodb-org 2>&1
    echo '---'
    apt-cache madison mongodb-org 2>&1 || true
  args:
    executable: /bin/bash
  register: mongodb_org_policy
  changed_when: false

- name: Display mongodb-org apt-cache output
  debug:
    msg: "{{ mongodb_org_policy.stdout | default('') }}"

- name: Fail early if mongodb-org is not available
  fail:
    msg: |
      mongodb-org package is not available after adding MongoDB apt repo.

      Output:
      {{ mongodb_org_policy.stdout | default('') }}
  when: >
    mongodb_org_policy.stdout is not defined or
    (mongodb_org_policy.stdout | trim) == '' or
    'Candidate: (none)' in mongodb_org_policy.stdout or
    'Unable to locate package' in mongodb_org_policy.stdout

# ==============================================
# MongoDB installation & service
# ==============================================
- name: Install MongoDB (mongodb-org)
  apt:
    name: mongodb-org
    state: present

- name: Ensure mongod service is started and enabled
  systemd:
    name: mongod
    state: started
    enabled: yes

- name: Wait for MongoDB to be ready (localhost)
  wait_for:
    port: 27017
    host: 127.0.0.1
    timeout: 60

# ==============================================
# MongoDB configuration (bind to host, enable auth)
# ==============================================
- name: Create MongoDB configuration for cluster access (bind + auth)
  copy:
    dest: /etc/mongod.conf
    mode: '0644'
    content: |
      storage:
        dbPath: /var/lib/mongodb
        journal:
          enabled: true
      systemLog:
        destination: file
        logAppend: true
        path: /var/log/mongodb/mongod.log
      net:
        port: 27017
        bindIp: 0.0.0.0
      processManagement:
        timeZoneInfo: /usr/share/zoneinfo
      security:
        authorization: enabled
  register: mongod_config

- name: Restart MongoDB if configuration changed
  systemd:
    name: mongod
    state: restarted
  when: mongod_config.changed

- name: Wait for MongoDB after restart
  wait_for:
    port: 27017
    host: 127.0.0.1
    timeout: 60
  when: mongod_config.changed

# ==============================================
# Users (admin + shared app user)
# ==============================================
# We try auth first (idempotent updates); if that fails (fresh bootstrap),
# fall back to localhost bootstrap without auth.
- name: Ensure admin user exists / password is up-to-date (try authenticated)
  shell: |
    mongosh --quiet \
      --username "admin" \
      --password "{{ mongodb_root_password }}" \
      --authenticationDatabase "admin" \
      --eval 'db.getSiblingDB("admin").updateUser("admin", {pwd: "{{ mongodb_root_password }}"});'
  register: mongodb_admin_update_auth
  changed_when: false
  failed_when: false

- name: Ensure admin user exists (bootstrap without auth if needed)
  shell: |
    mongosh --quiet --eval '
      const adm = db.getSiblingDB("admin");
      const user = adm.getUser("admin");
      if (!user) {
        adm.createUser({
          user: "admin",
          pwd: "{{ mongodb_root_password }}",
          roles: [ { role: "root", db: "admin" } ]
        });
        print("created_admin_user");
      } else {
        print("admin_user_exists");
      }
    '
  register: mongodb_admin_bootstrap
  changed_when: "'created_admin_user' in mongodb_admin_bootstrap.stdout"
  when: mongodb_admin_update_auth.rc != 0

- name: Ensure app user exists / password is up-to-date
  shell: |
    mongosh --quiet \
      --username "admin" \
      --password "{{ mongodb_root_password }}" \
      --authenticationDatabase "admin" \
      --eval '
        const adm = db.getSiblingDB("admin");
        const u = adm.getUser("{{ mongodb_wapps_username }}");
        if (!u) {
          adm.createUser({
            user: "{{ mongodb_wapps_username }}",
            pwd: "{{ mongodb_wapps_password }}",
            roles: [ { role: "readWriteAnyDatabase", db: "admin" } ]
          });
          print("created_app_user");
        } else {
          adm.updateUser("{{ mongodb_wapps_username }}", { pwd: "{{ mongodb_wapps_password }}" });
          print("updated_app_user");
        }
      '
  register: mongodb_app_user
  changed_when: "'created_app_user' in mongodb_app_user.stdout or 'updated_app_user' in mongodb_app_user.stdout"

# ==============================================
# Firewall configuration
# ==============================================
- name: Allow MongoDB through firewall
  ufw:
    rule: allow
    port: "27017"
    proto: tcp
    comment: "MongoDB for Kubernetes cluster"

# ==============================================
# Kubernetes Service Integration (external host service)
# ==============================================
- name: Get host primary IP address
  set_fact:
    host_ip: "{{ ansible_default_ipv4.address }}"

- name: Display detected host IP for verification
  debug:
    msg: "Detected host IP address: {{ host_ip }}"

- name: Create MongoDB namespace in Kubernetes
  shell: kubectl create namespace mongodb --dry-run=client -o yaml | kubectl apply -f -
  register: mongodb_namespace

- name: Create Kubernetes Service for host MongoDB
  shell: |
    cat <<EOF | kubectl apply -f -
    apiVersion: v1
    kind: Service
    metadata:
      name: mongodb
      namespace: mongodb
      labels:
        app: mongodb
        type: external-host-service
      annotations:
        description: "MongoDB running on host machine"
    spec:
      type: ClusterIP
      ports:
        - name: mongodb
          port: 27017
          targetPort: 27017
          protocol: TCP
    EOF
  register: mongodb_k8s_service

- name: Create Kubernetes Endpoints for host MongoDB
  shell: |
    cat <<EOF | kubectl apply -f -
    apiVersion: v1
    kind: Endpoints
    metadata:
      name: mongodb
      namespace: mongodb
      labels:
        app: mongodb
        type: external-host-service
      annotations:
        description: "Points to MongoDB on host at {{ host_ip }}"
    subsets:
      - addresses:
          - ip: {{ host_ip }}
        ports:
          - name: mongodb
            port: 27017
            protocol: TCP
    EOF
  register: mongodb_k8s_endpoints

# ==============================================
# Shared MongoDB Credentials Secret
# ==============================================
- name: Create shared MongoDB credentials secret in mongodb namespace
  shell: |
    kubectl create secret generic mongodb-credentials \
      --namespace=mongodb \
      --from-literal=MONGODB_HOST=mongodb.mongodb \
      --from-literal=MONGODB_PORT=27017 \
      --from-literal=MONGODB_AUTH_DB=admin \
      --from-literal=MONGODB_USERNAME={{ mongodb_wapps_username }} \
      --from-literal=MONGODB_PASSWORD={{ mongodb_wapps_password }} \
      --dry-run=client -o yaml | kubectl apply -f -
  register: mongodb_shared_secret

# ==============================================
# Verification Tests
# ==============================================
- name: Test MongoDB connection from cluster
  shell: |
    kubectl run mongodb-connection-test \
      --rm -i --restart=Never \
      --image=mongo:7.0 \
      --namespace=mongodb \
      --command -- \
      mongosh "mongodb://{{ mongodb_wapps_username }}:{{ mongodb_wapps_password }}@mongodb.mongodb:27017/admin?authSource=admin" \
      --eval 'db.runCommand({ ping: 1 })'
  register: mongodb_cluster_test
  changed_when: false
  failed_when: false

- name: Get Kubernetes Service ClusterIP
  shell: kubectl get service mongodb -n mongodb -o jsonpath='{.spec.clusterIP}'
  register: mongodb_service_ip
  changed_when: false

- name: Get Kubernetes Endpoints IP
  shell: kubectl get endpoints mongodb -n mongodb -o jsonpath='{.subsets[0].addresses[0].ip}'
  register: mongodb_endpoint_ip
  changed_when: false

# ==============================================
# Display Installation Summary
# ==============================================
- name: Display MongoDB installation summary
  debug:
    msg: |
      â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
      â•‘          MongoDB Installation Complete                         â•‘
      â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      ðŸ“Š DATABASE INFORMATION:
      â”œâ”€ Host IP: {{ host_ip }}
      â”œâ”€ Port: 27017
      â”œâ”€ Bind Address: 0.0.0.0 (accessible from cluster)
      â””â”€ Auth: enabled (admin + app user)
      
      ðŸ‘¤ USERS:
      â”œâ”€ Admin user: admin (auth DB: admin)
      â””â”€ App user: {{ mongodb_wapps_username }} (role: readWriteAnyDatabase)
      
      â˜¸ï¸  KUBERNETES INTEGRATION:
      â”œâ”€ Namespace: mongodb
      â”œâ”€ Service Name: mongodb
      â”œâ”€ Service ClusterIP: {{ mongodb_service_ip.stdout }}
      â”œâ”€ Endpoint IP: {{ mongodb_endpoint_ip.stdout }} (host)
      â””â”€ DNS: mongodb.mongodb.svc.cluster.local
      
      ðŸ” KUBERNETES SECRETS CREATED:
      â””â”€ mongodb-credentials (namespace: mongodb)
      
      âœ… CONNECTION TESTS:
      â””â”€ From Cluster: {{ 'PASSED âœ“' if mongodb_cluster_test.rc == 0 else 'CHECK LOGS' }}
      
      ðŸ“ USAGE IN PODS:
        envFrom:
          - secretRef:
              name: mongodb-credentials
      
      MongoDB is accessible from pods via: mongodb.mongodb:27017

