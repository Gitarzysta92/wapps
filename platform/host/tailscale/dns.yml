---
- name: Check if Tailscale domain is provided
  debug:
    msg: "Skipping DNS configuration - TAILSCALE_DOMAIN not provided"
  when: tailscale_domain is not defined or tailscale_domain == ""

- name: Extract tailnet name from domain
  set_fact:
    tailnet_name: "{{ tailscale_domain | regex_replace('\\.ts\\.net$', '') }}"
  when: tailscale_domain is defined and tailscale_domain != ""

- name: Get Tailscale IP using CLI
  shell: tailscale ip -4
  register: tailscale_ip_result
  changed_when: false
  failed_when: false
  when: tailscale_domain is defined and tailscale_domain != ""

- name: Debug Tailscale IP
  debug:
    msg: |
      Tailscale IP: {{ tailscale_ip_result.stdout | default('not found') }}
      Tailscale domain: {{ tailscale_domain | default('undefined') }}
      Tailnet name: {{ tailnet_name | default('undefined') }}
      Device name: {{ tailscale_device_name | default('undefined') }}

- name: Create DNS A record for K3s API
  uri:
    url: "https://api.tailscale.com/api/v2/dns/nameservers/{{ tailnet_name }}/records"
    method: POST
    headers:
      Authorization: "Bearer {{ tailscale_api_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      type: "A"
      name: "k3s-api.{{ tailscale_device_name }}"
      value: "{{ tailscale_ip_result.stdout }}"
    status_code: 200
  register: k3s_dns_record
  when: 
    - tailscale_api_token is defined and tailscale_api_token != ""
    - tailscale_domain is defined and tailscale_domain != ""
    - tailscale_ip_result.stdout is defined and tailscale_ip_result.stdout != ""
  ignore_errors: yes

- name: Create DNS A record for ArgoCD
  uri:
    url: "https://api.tailscale.com/api/v2/dns/nameservers/{{ tailnet_name }}/records"
    method: POST
    headers:
      Authorization: "Bearer {{ tailscale_api_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      type: "A"
      name: "argocd.{{ tailscale_device_name }}"
      value: "{{ tailscale_ip_result.stdout }}"
    status_code: 200
  register: argocd_dns_record
  when: 
    - tailscale_api_token is defined and tailscale_api_token != ""
    - tailscale_domain is defined and tailscale_domain != ""
    - tailscale_ip_result.stdout is defined and tailscale_ip_result.stdout != ""
  ignore_errors: yes

- name: Create DNS A record for Node Exporter
  uri:
    url: "https://api.tailscale.com/api/v2/dns/nameservers/{{ tailnet_name }}/records"
    method: POST
    headers:
      Authorization: "Bearer {{ tailscale_api_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      type: "A"
      name: "metrics.{{ tailscale_device_name }}"
      value: "{{ tailscale_ip_result.stdout }}"
    status_code: 200
  register: metrics_dns_record
  when: 
    - tailscale_api_token is defined and tailscale_api_token != ""
    - tailscale_domain is defined and tailscale_domain != ""
    - tailscale_ip_result.stdout is defined and tailscale_ip_result.stdout != ""
  ignore_errors: yes

- name: Debug DNS record creation results
  debug:
    msg: |
      DNS Record Creation Results:
      - K3s API: {{ 'Success' if k3s_dns_record is defined and k3s_dns_record.status == 200 else 'Failed' }}
      - ArgoCD: {{ 'Success' if argocd_dns_record is defined and argocd_dns_record.status == 200 else 'Failed' }}
      - Node Exporter: {{ 'Success' if metrics_dns_record is defined and metrics_dns_record.status == 200 else 'Failed' }}
      
      {% if k3s_dns_record is defined and k3s_dns_record.status != 200 %}
      K3s API Error: {{ k3s_dns_record.json | default('Unknown error') }}
      {% endif %}
      {% if argocd_dns_record is defined and argocd_dns_record.status != 200 %}
      ArgoCD Error: {{ argocd_dns_record.json | default('Unknown error') }}
      {% endif %}
      {% if metrics_dns_record is defined and metrics_dns_record.status != 200 %}
      Node Exporter Error: {{ metrics_dns_record.json | default('Unknown error') }}
      {% endif %}

- name: Display DNS configuration status
  debug:
    msg: |
      {% if tailscale_api_token is defined and tailscale_api_token != "" and tailscale_domain is defined and tailscale_domain != "" and tailscale_ip_result.stdout is defined and tailscale_ip_result.stdout != "" %}
      Tailscale DNS records created successfully!
      
      Service URLs:
      - K3s API: https://k3s-api.{{ tailscale_device_name }}.{{ tailscale_domain }}
      - ArgoCD: https://argocd.{{ tailscale_device_name }}.{{ tailscale_domain }}
      - Node Exporter: http://metrics.{{ tailscale_device_name }}.{{ tailscale_domain }}
      
      Device hostname: {{ tailscale_device_name }}
      Tailscale IP: {{ tailscale_ip_result.stdout }}
      Tailnet: {{ tailnet_name }}
      {% elif tailscale_domain is defined and tailscale_domain != "" %}
      DNS configuration failed - API token may be invalid or insufficient permissions
      {% else %}
      DNS configuration skipped - domain not provided
      {% endif %}