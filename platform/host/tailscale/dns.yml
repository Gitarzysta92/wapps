---
- name: Check if Tailscale domain is provided
  debug:
    msg: "Skipping DNS configuration - TAILSCALE_DOMAIN not provided"
  when: tailscale_domain is not defined or tailscale_domain == ""

- name: Extract tailnet name from domain
  set_fact:
    tailnet_name: "{{ tailscale_domain | regex_replace('\\.ts\\.net$', '') }}"
  when: tailscale_domain is defined and tailscale_domain != ""

- name: Get Tailscale IP using CLI
  shell: tailscale ip -4
  register: tailscale_ip_result
  changed_when: false
  failed_when: false
  when: tailscale_domain is defined and tailscale_domain != ""

- name: Debug Tailscale IP
  debug:
    msg: |
      Tailscale IP: {{ tailscale_ip_result.stdout | default('not found') }}
      Tailscale domain: {{ tailscale_domain | default('undefined') }}
      Tailnet name: {{ tailnet_name | default('undefined') }}
      Device name: {{ tailscale_device_name | default('undefined') }}

- name: Install dnsmasq
  package:
    name: dnsmasq
    state: present

- name: Stop and disable systemd-resolved
  systemd:
    name: systemd-resolved
    state: stopped
    enabled: no
    daemon_reload: yes

- name: Create systemd-resolved configuration directory
  file:
    path: /etc/systemd/resolved.conf.d
    state: directory
    mode: '0755'

- name: Remove systemd-resolved DNS configuration
  file:
    path: /etc/systemd/resolved.conf.d/99-dns.conf
    state: absent

- name: Create systemd-resolved override to disable DNS stub
  copy:
    content: |
      [Resolve]
      DNSStubListener=no
    dest: /etc/systemd/resolved.conf.d/99-dns.conf
    mode: '0644'

- name: Restart systemd-resolved
  systemd:
    name: systemd-resolved
    state: restarted
    daemon_reload: yes

- name: Create dnsmasq configuration directory
  file:
    path: /etc/dnsmasq.d
    state: directory
    mode: '0755'

- name: Create dnsmasq configuration for environments
  copy:
    content: |
      # Tailscale DNS configuration for {{ target_env }} environment
      # Generated by Ansible - do not edit manually
      
      # Listen on all interfaces including Tailscale
      listen-address=127.0.0.1
      listen-address={{ ansible_default_ipv4.address }}
      listen-address={{ tailscale_ip_result.stdout }}
      
      # Bind to port 53
      port=53
      
      # Enable logging
      log-queries
      log-dhcp
      
      # Wildcard DNS for {{ target_env }}.wapps.com
      # This will resolve ANY subdomain to the Tailscale IP
      address=/{{ target_env }}.wapps.com/{{ tailscale_ip_result.stdout }}
      
      # Forward other queries to system DNS
      server=8.8.8.8
      server=1.1.1.1
      
      # Cache settings
      cache-size=1000
      neg-ttl=3600
      
      # Don't read /etc/hosts
      no-hosts
      
      # Don't read /etc/resolv.conf
      no-resolv
    dest: /etc/dnsmasq.d/tailscale-{{ target_env }}.conf
    mode: '0644'
  when: 
    - tailscale_domain is defined and tailscale_domain != ""
    - tailscale_ip_result.stdout is defined and tailscale_ip_result.stdout != ""

- name: Create main dnsmasq configuration
  copy:
    content: |
      # Main dnsmasq configuration
      # Generated by Ansible - do not edit manually
      
      # Include environment-specific configs
      conf-dir=/etc/dnsmasq.d
      
      # Log to syslog
      log-facility=/var/log/dnsmasq.log
    dest: /etc/dnsmasq.conf
    mode: '0644'

- name: Start and enable dnsmasq
  systemd:
    name: dnsmasq
    state: started
    enabled: yes
    daemon_reload: yes

- name: Wait for dnsmasq to start
  wait_for:
    port: 53
    host: "{{ ansible_default_ipv4.address }}"
    timeout: 10
  ignore_errors: yes

- name: Test DNS resolution
  shell: |
    nslookup argocd.{{ target_env }}.wapps.com {{ ansible_default_ipv4.address }}
  register: dns_test_result
  changed_when: false
  failed_when: false
  when: 
    - tailscale_domain is defined and tailscale_domain != ""
    - tailscale_ip_result.stdout is defined and tailscale_ip_result.stdout != ""

- name: Debug DNS test result
  debug:
    msg: |
      DNS Test Result:
      {{ dns_test_result.stdout | default('DNS test not run') }}
  when: dns_test_result is defined

- name: Configure Tailscale Split DNS
  uri:
    url: "https://api.tailscale.com/api/v2/tailnet/{{ tailnet_name }}/dns/nameservers"
    method: POST
    headers:
      Authorization: "Bearer {{ tailscale_api_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      domains: ["{{ target_env }}.wapps.com"]
      nameservers: ["{{ ansible_default_ipv4.address }}"]
    status_code: 200
  register: tailscale_split_dns
  when: 
    - tailscale_api_token is defined and tailscale_api_token != ""
    - tailnet_name is defined
    - tailscale_domain is defined and tailscale_domain != ""
    - tailscale_ip_result.stdout is defined and tailscale_ip_result.stdout != ""
  ignore_errors: yes

- name: Add search domain to Tailscale
  uri:
    url: "https://api.tailscale.com/api/v2/tailnet/{{ tailnet_name }}/dns/searchpaths"
    method: POST
    headers:
      Authorization: "Bearer {{ tailscale_api_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      searchPaths: ["{{ target_env }}.wapps.com"]
    status_code: 200
  register: tailscale_search_path
  when: 
    - tailscale_api_token is defined and tailscale_api_token != ""
    - tailnet_name is defined
    - tailscale_domain is defined and tailscale_domain != ""
    - tailscale_ip_result.stdout is defined and tailscale_ip_result.stdout != ""
  ignore_errors: yes

- name: Display DNS configuration status
  debug:
    msg: |
      {% if tailscale_domain is defined and tailscale_domain != "" and tailscale_ip_result.stdout is defined and tailscale_ip_result.stdout != "" %}
      ‚úÖ dnsmasq DNS configuration completed successfully!
      
      üåê Wildcard DNS: *.{{ target_env }}.wapps.com ‚Üí {{ tailscale_ip_result.stdout }}
      
      üìç Service URLs (all resolve to the same IP):
      - ArgoCD: https://argocd.{{ target_env }}.wapps.com
      - K3s API: https://k3s-api.{{ target_env }}.wapps.com
      - Node Exporter: http://metrics.{{ target_env }}.wapps.com
      - Grafana: https://grafana.{{ target_env }}.wapps.com
      - Prometheus: https://prometheus.{{ target_env }}.wapps.com
      - ANY service: https://anything.{{ target_env }}.wapps.com
      
      üîß Device info:
      - Device hostname: {{ tailscale_device_name }}
      - Tailscale IP: {{ tailscale_ip_result.stdout }}
      - Environment: {{ target_env }}
      - DNS Server: {{ ansible_default_ipv4.address }}:53
      
      {% if tailscale_split_dns is defined and tailscale_split_dns.status == 200 %}
      ‚úÖ Tailscale Split DNS configured automatically!
      - Domain: {{ target_env }}.wapps.com ‚Üí {{ ansible_default_ipv4.address }}:53
      - All Tailscale devices will now resolve these domains automatically!
      {% else %}
      üìã Manual setup required:
      1. In Tailscale admin console ‚Üí DNS ‚Üí Split DNS
      2. Add: {{ target_env }}.wapps.com ‚Üí {{ ansible_default_ipv4.address }}
      3. All devices will then resolve *.{{ target_env }}.wapps.com automatically!
      {% endif %}
      {% else %}
      ‚ùå DNS configuration failed - missing required variables
      {% endif %}