---
- name: Check if Tailscale API token is provided
  fail:
    msg: "TAILSCALE_API_TOKEN is required for DNS management"
  when: tailscale_api_token is not defined

- name: Get Tailscale device information
  uri:
    url: "https://api.tailscale.com/api/v2/device/{{ tailscale_device_name }}"
    method: GET
    headers:
      Authorization: "Bearer {{ tailscale_api_token }}"
    status_code: 200
  register: tailscale_device
  when: tailscale_api_token is defined

- name: Get Tailscale IP from device info
  set_fact:
    tailscale_device_ip: "{{ tailscale_device.json.addresses[0] }}"
  when: tailscale_device is defined and tailscale_device.json.addresses is defined

- name: Create DNS A record for K3s API
  uri:
    url: "https://api.tailscale.com/api/v2/dns/nameservers/{{ tailscale_domain }}/records"
    method: POST
    headers:
      Authorization: "Bearer {{ tailscale_api_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      type: "A"
      name: "k3s-api"
      value: "{{ tailscale_device_ip }}"
    status_code: 200
  register: k3s_dns_record
  when: tailscale_api_token is defined and tailscale_device_ip is defined

- name: Create DNS A record for ArgoCD
  uri:
    url: "https://api.tailscale.com/api/v2/dns/nameservers/{{ tailscale_domain }}/records"
    method: POST
    headers:
      Authorization: "Bearer {{ tailscale_api_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      type: "A"
      name: "argocd"
      value: "{{ tailscale_device_ip }}"
    status_code: 200
  register: argocd_dns_record
  when: tailscale_api_token is defined and tailscale_device_ip is defined

- name: Create DNS A record for Node Exporter
  uri:
    url: "https://api.tailscale.com/api/v2/dns/nameservers/{{ tailscale_domain }}/records"
    method: POST
    headers:
      Authorization: "Bearer {{ tailscale_api_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      type: "A"
      name: "metrics"
      value: "{{ tailscale_device_ip }}"
    status_code: 200
  register: metrics_dns_record
  when: tailscale_api_token is defined and tailscale_device_ip is defined

- name: Display DNS configuration status
  debug:
    msg: |
      Tailscale DNS records created successfully!
      
      Service URLs:
      - K3s API: https://k3s-api.\{\{ tailscale_domain }}:6443
      - ArgoCD: http://argocd.\{\{ tailscale_domain }}:30080
      - Node Exporter: http://metrics.\{\{ tailscale_domain }}:9100/metrics
      
      Device hostname: {{ tailscale_device_name }}
      Device IP: {{ tailscale_device_ip }}
  when: tailscale_api_token is defined and tailscale_device_ip is defined
