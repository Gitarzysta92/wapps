---
- name: Check if Tailscale API token and domain are provided
  debug:
    msg: "Skipping DNS configuration - TAILSCALE_API_TOKEN or TAILSCALE_DOMAIN not provided"
  when: tailscale_api_token is not defined or tailscale_api_token == "" or tailscale_domain is not defined or tailscale_domain == ""

- name: Extract tailnet name from domain
  set_fact:
    tailnet_name: "{{ tailscale_domain | regex_replace('\\.ts\\.net$', '') }}"
  when: tailscale_domain is defined and tailscale_domain != ""

- name: Debug Tailscale variables
  debug:
    msg: |
      tailscale_api_token: {{ 'defined' if tailscale_api_token is defined else 'undefined' }}
      tailscale_domain: {{ tailscale_domain | default('undefined') }}
      tailnet_name: {{ tailnet_name | default('undefined') }}
      tailscale_device_name: {{ tailscale_device_name | default('undefined') }}

- name: Get Tailscale device information
  uri:
    url: "https://api.tailscale.com/api/v2/devices"
    method: GET
    headers:
      Authorization: "Bearer {{ tailscale_api_token }}"
    status_code: 200
  register: tailscale_devices
  when: 
    - tailscale_api_token is defined and tailscale_api_token != ""
  ignore_errors: yes

- name: Debug Tailscale API response
  debug:
    msg: |
      API Status: {{ tailscale_devices.status | default('not called') }}
      API Response: {{ tailscale_devices.json | default('no response') }}
  when: tailscale_devices is defined

- name: Debug device search conditions
  debug:
    msg: |
      Conditions check:
      - tailscale_api_token defined: {{ tailscale_api_token is defined and tailscale_api_token != "" }}
      - tailscale_devices defined: {{ tailscale_devices is defined }}
      - API status 200: {{ tailscale_devices.status == 200 if tailscale_devices is defined else 'N/A' }}
      - Looking for device: {{ tailscale_device_name | default('undefined') }}
      - Available devices: {{ tailscale_devices.json.devices | map(attribute='hostname') | list if tailscale_devices is defined and tailscale_devices.json is defined else 'none' }}

- name: Find device by hostname
  set_fact:
    tailscale_device_ip: "{{ item.addresses[0] }}"
  loop: "{{ tailscale_devices.json.devices }}"
  when: 
    - tailscale_api_token is defined and tailscale_api_token != ""
    - tailscale_devices is defined
    - tailscale_devices.status == 200
    - item.hostname == tailscale_device_name
  loop_control:
    label: "{{ item.hostname }}"

- name: Debug device IP result
  debug:
    msg: |
      tailscale_device_ip: {{ tailscale_device_ip | default('not found') }}

- name: Create DNS A record for K3s API
  uri:
    url: "https://api.tailscale.com/api/v2/dns/nameservers/{{ tailnet_name }}/records"
    method: POST
    headers:
      Authorization: "Bearer {{ tailscale_api_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      type: "A"
      name: "k3s-api.{{ tailscale_device_name }}"
      value: "{{ tailscale_device_ip }}"
    status_code: 200
  register: k3s_dns_record
  when: 
    - tailscale_api_token is defined and tailscale_api_token != ""
    - tailscale_device_ip is defined
  ignore_errors: yes

- name: Create DNS A record for ArgoCD
  uri:
    url: "https://api.tailscale.com/api/v2/dns/nameservers/{{ tailnet_name }}/records"
    method: POST
    headers:
      Authorization: "Bearer {{ tailscale_api_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      type: "A"
      name: "argocd.{{ tailscale_device_name }}"
      value: "{{ tailscale_device_ip }}"
    status_code: 200
  register: argocd_dns_record
  when: 
    - tailscale_api_token is defined and tailscale_api_token != ""
    - tailscale_device_ip is defined
  ignore_errors: yes

- name: Create DNS A record for Node Exporter
  uri:
    url: "https://api.tailscale.com/api/v2/dns/nameservers/{{ tailnet_name }}/records"
    method: POST
    headers:
      Authorization: "Bearer {{ tailscale_api_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      type: "A"
      name: "metrics.{{ tailscale_device_name }}"
      value: "{{ tailscale_device_ip }}"
    status_code: 200
  register: metrics_dns_record
  when: 
    - tailscale_api_token is defined and tailscale_api_token != ""
    - tailscale_device_ip is defined
  ignore_errors: yes

- name: Display DNS configuration status
  debug:
    msg: |
      {% if tailscale_api_token is defined and tailscale_api_token != "" and tailscale_device_ip is defined %}
      Tailscale DNS records created successfully!
      
      Service URLs:
      - K3s API: https://k3s-api.{{ tailscale_device_name }}.{{ tailscale_domain }}
      - ArgoCD: https://argocd.{{ tailscale_device_name }}.{{ tailscale_domain }}
      - Node Exporter: http://metrics.{{ tailscale_device_name }}.{{ tailscale_domain }}
      
      Device hostname: {{ tailscale_device_name }}
      Device IP: {{ tailscale_device_ip }}
      Tailnet: {{ tailnet_name }}
      {% elif tailscale_api_token is defined and tailscale_api_token != "" %}
      DNS configuration failed - API token may be invalid or insufficient permissions
      {% else %}
      DNS configuration skipped - API token or domain not provided
      {% endif %}
