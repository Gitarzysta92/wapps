---
- name: Install Tailscale
  shell: |
    curl -fsSL https://tailscale.com/install.sh | sh
  register: tailscale_install
  changed_when: tailscale_install.rc == 0

- name: Start Tailscale daemon
  systemd:
    name: tailscaled
    state: started
    enabled: yes
  become: yes

- name: Wait for Tailscale daemon to start
  wait_for:
    path: /var/run/tailscale/tailscaled.sock
    timeout: 30
  ignore_errors: yes

- name: Check Tailscale daemon status
  systemd:
    name: tailscaled
  register: tailscale_status
  changed_when: false

- name: Display Tailscale daemon status
  debug:
    msg: "Tailscale daemon status: {{ tailscale_status.status.ActiveState }}"

- name: Set Tailscale hostname
  set_fact:
    tailscale_device_name: "{{ target_env }}-wapps"

- name: Authenticate Tailscale with auth key
  shell: tailscale up --authkey="{{ tailscale_auth_key }}" --hostname="{{ tailscale_device_name }}" --accept-dns=true
  when: tailscale_auth_key is defined
  register: tailscale_auth
  changed_when: tailscale_auth.rc == 0

- name: Display Tailscale authentication status
  debug:
    msg: |
      Tailscale authentication {{ 'completed' if tailscale_auth_key is defined else 'skipped - no auth key provided' }}!
      Device hostname: {{ tailscale_device_name }}
      
      {% if tailscale_auth_key is defined %}
      After authentication, your services will be available at:
      - K3s API: https://\{\{ ansible_default_ipv4.address }}:6443 (or via Tailscale IP)
      - ArgoCD: http://\{\{ ansible_default_ipv4.address }}:30080 (or via Tailscale IP)
      - Node Exporter: http://\{\{ ansible_default_ipv4.address }}:9100/metrics (or via Tailscale IP)
      
      Tailscale will provide DNS names like:
      - {{ tailscale_device_name }}.tailnet-name.ts.net
      - {{ tailscale_device_name }}.ts.net (if MagicDNS is enabled)
      {% else %}
      To authenticate manually, run: sudo tailscale up --hostname="{{ tailscale_device_name }}"
      {% endif %}

- name: Configure Tailscale for K3s external access
  block:
    - name: Get Tailscale IP
      shell: tailscale ip -4
      register: tailscale_ip
      changed_when: false
      failed_when: false

    - name: Update kubeconfig with Tailscale IP
      replace:
        path: "{{ ansible_user_dir }}/.kube/config"
        regexp: 'https://{{ ansible_default_ipv4.address }}:6443'
        replace: 'https://{{ tailscale_ip.stdout | default(ansible_default_ipv4.address) }}:6443'
      when: tailscale_ip.stdout is defined and tailscale_ip.stdout != ""

    - name: Display Tailscale networking info
      debug:
        msg: |
          Tailscale IP: {{ tailscale_ip.stdout | default('Not available yet - authenticate first') }}
          Device hostname: {{ tailscale_device_name }}
          K3s API will be available at: https://\{\{ tailscale_ip.stdout | default(ansible_default_ipv4.address) }}:6443
          ArgoCD will be available at: http://\{\{ tailscale_ip.stdout | default(ansible_default_ipv4.address) }}:30080
