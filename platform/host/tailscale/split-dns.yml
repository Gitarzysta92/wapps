---
- name: Check if Tailscale domain is provided
  debug:
    msg: "Skipping Tailscale Split DNS configuration - TAILSCALE_DOMAIN not provided"
  when: tailscale_domain is not defined or tailscale_domain == ""

- name: Get Tailscale IP using CLI
  shell: tailscale ip -4
  register: tailscale_ip_result
  changed_when: false
  failed_when: false
  when: tailscale_domain is defined and tailscale_domain != ""

- name: Debug Tailscale IP
  debug:
    msg: |
      Tailscale IP: {{ tailscale_ip_result.stdout | default('not found') }}
      Tailscale domain: {{ tailscale_domain | default('undefined') }}
      Device name: {{ tailscale_device_name | default('undefined') }}

- name: Configure Tailscale Split DNS for development domain
  uri:
    url: "https://api.tailscale.com/api/v2/tailnet/{{ tailnet_name }}/dns/nameservers"
    method: POST
    headers:
      Authorization: "Bearer {{ tailscale_api_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      domains: ["{{ target_env }}.wapps.com"]
      nameservers: ["{{ ansible_default_ipv4.address }}:5353"]
    status_code: 200
  register: tailscale_split_dns
  when: 
    - tailscale_api_token is defined and tailscale_api_token != ""
    - tailnet_name is defined
    - tailscale_domain is defined and tailscale_domain != ""
    - tailscale_ip_result.stdout is defined and tailscale_ip_result.stdout != ""
  ignore_errors: yes

- name: Test Tailscale DNS resolution
  shell: |
    tailscale status --json | jq -r '.Self.DNS | join(",")'
  register: tailscale_dns_status
  changed_when: false
  failed_when: false
  when: 
    - tailscale_domain is defined and tailscale_domain != ""
    - tailscale_ip_result.stdout is defined and tailscale_ip_result.stdout != ""

- name: Debug Tailscale DNS status
  debug:
    msg: |
      Current Tailscale DNS: {{ tailscale_dns_status.stdout | default('No DNS info') }}
      Split DNS API Status: {{ 'Success' if tailscale_split_dns is defined and tailscale_split_dns.status is defined and tailscale_split_dns.status == 200 else 'Failed' }}
      {% if tailscale_split_dns is defined and tailscale_split_dns.status is defined and tailscale_split_dns.status != 200 %}
      API Error: {{ tailscale_split_dns.json | default('Unknown error') }}
      {% endif %}
  when: tailscale_dns_status is defined

- name: Display Tailscale Split DNS configuration status
  debug:
    msg: |
      {% if tailscale_domain is defined and tailscale_domain != "" and tailscale_ip_result.stdout is defined and tailscale_ip_result.stdout != "" %}
      ‚úÖ Tailscale Split DNS configured successfully!
      
      üîß Device info:
      - Device hostname: {{ tailscale_device_name }}
      - Tailscale IP: {{ tailscale_ip_result.stdout }}
      - Environment: {{ target_env }}
      - DNS Server: {{ ansible_default_ipv4.address }}:5353
      
      üìã Configuration:
      {% if tailscale_split_dns is defined and tailscale_split_dns.status is defined and tailscale_split_dns.status == 200 %}
      - ‚úÖ Split DNS configured for {{ target_env }}.wapps.com
      - Custom nameserver: {{ ansible_default_ipv4.address }}:5353
      - dnsmasq resolves *.{{ target_env }}.wapps.com to {{ tailscale_ip_result.stdout }}
      - All other domains use normal system DNS
      {% else %}
      - ‚ùå Split DNS configuration failed (API error or missing token)
      - Manual setup required in Tailscale admin console
      - Add nameserver {{ ansible_default_ipv4.address }}:5353 for domain {{ target_env }}.wapps.com
      - Or check if TAILSCALE_API_TOKEN is valid and has proper permissions
      {% endif %}
      
      üåê Service URLs (via Tailscale):
      - ArgoCD: https://argocd.{{ target_env }}.wapps.com
      - K3s API: https://k3s-api.{{ target_env }}.wapps.com
      - Node Exporter: http://metrics.{{ target_env }}.wapps.com
      - ANY service: https://anything.{{ target_env }}.wapps.com
      {% else %}
      ‚ùå Tailscale Split DNS configuration failed - missing required variables
      {% endif %}
