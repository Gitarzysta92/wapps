# RabbitMQ Helm Chart Values
# Chart: bitnami/rabbitmq
# Docs: https://github.com/bitnami/charts/tree/main/bitnami/rabbitmq

# Global settings - allow bitnamilegacy repository
global:
  security:
    allowInsecureImages: true  # Required for bitnamilegacy repository

# Authentication - provided via --set at install time
# auth:
#   username: <secret>       # From GitHub Secrets
#   password: <secret>       # From GitHub Secrets
#   erlangCookie: <secret>   # From GitHub Secrets

# Image override - Bitnami paywall workaround
# Bitnami moved specific revision tags to legacy repo (late 2024)
# Using bitnamilegacy repository to get exact version chart expects
image:
  registry: docker.io
  repository: bitnamilegacy/rabbitmq  # Legacy repo with specific revision tags
  tag: 4.1.3-debian-12-r1  # Exact version chart 16.0.14 expects
  pullPolicy: IfNotPresent

# Service Configuration
service:
  type: ClusterIP
  ports:
    amqp: 5672
    amqpTls: 5671
    dist: 25672
    manager: 15672
    epmd: 4369
    metrics: 9419

# Persistence
persistence:
  enabled: true
  size: 10Gi
  storageClass: "local-path"

# Resources
resources:
  requests:
    cpu: 250m
    memory: 512Mi
  limits:
    cpu: 500m
    memory: 1Gi

# High Availability
replicaCount: 1

# Load definitions to manage users/vhosts declaratively
# This ensures correct users even when restoring from persistent data
loadDefinition:
  enabled: true
  existingSecret: ""  # Will create inline definitions

extraConfiguration: |-
  load_definitions = /app/load_definition.json

extraSecrets:
  load-definition:
    load_definition.json: |
      {
        "users": [
          {
            "name": "admin",
            "password": "changeme",
            "tags": ["administrator"]
          }
        ],
        "vhosts": [
          {
            "name": "/"
          }
        ],
        "permissions": [
          {
            "user": "admin",
            "vhost": "/",
            "configure": ".*",
            "write": ".*",
            "read": ".*"
          }
        ]
      }

extraVolumes:
  - name: load-definition
    secret:
      secretName: rabbitmq-load-definition

extraVolumeMounts:
  - name: load-definition
    mountPath: /app
    readOnly: true

# Metrics
metrics:
  enabled: true
  serviceMonitor:
    enabled: false

# Plugins
plugins: "rabbitmq_management rabbitmq_prometheus"

# Configuration
configuration: |-
  ## Clustering
  cluster_formation.peer_discovery_backend = rabbit_peer_discovery_k8s
  cluster_formation.k8s.host = kubernetes.default.svc.cluster.local
  cluster_formation.k8s.address_type = hostname
  
  ## Queue master location
  queue_master_locator = min-masters

