apiVersion: v1
kind: ConfigMap
metadata:
  name: kong-config
  namespace: kong
data:
  kong.yml: |
    _format_version: "3.0"
    
    # NOTE: Firebase JWT validation in Kong Open Source
    # Kong's openid-connect plugin is Enterprise-only.
    # For open-source Kong with Firebase auth, you have two options:
    # 
    # Option 1: Backend validation (RECOMMENDED)
    #   - Kong routes to your backend without auth
    #   - Backend validates Firebase tokens using Firebase Admin SDK
    #   - See: platform/cluster/kong/BACKEND-FIREBASE-AUTH.md
    #
    # Option 2: Custom Lua plugin
    #   - Write custom Kong plugin to validate Firebase JWTs
    #   - Fetch JWKS from Firebase and validate signatures
    #   - More complex but keeps auth at gateway layer
    #
    # Current config: Protected routes return 401 until backend auth is implemented
    
    # Consumers for optional authentication
    consumers:
    - username: anonymous-user
      custom_id: anonymous
    
    services:
    - name: aggregator-ssr-service
      url: http://aggregator-ssr-service.aggregator:80
      
    - name: cdn-service
      url: https://your-cdn-domain.com

    - name: catalog-bff-service
      url: http://catalog-bff-service.catalog:80
      
    routes:
    # Catalog BFF API routes - Public (no auth required)
    - name: catalog-public-listings-route
      service: catalog-bff-service
      hosts:
      - api.development.wapps.com
      paths:
      - /catalog/listings
      - /catalog/search
      strip_path: false
      plugins:
      - name: rate-limiting
        config:
          minute: 100
          hour: 2000
      - name: response-transformer
        config:
          add:
            headers:
            - "X-Route-Type: api-public"
            - "X-Service: catalog-bff"
    
    # Catalog BFF API routes - Protected (auth required)
    - name: catalog-protected-route
      service: catalog-bff-service
      hosts:
      - api.development.wapps.com
      paths:
      - /catalog/my-listings
      - /catalog/favorites
      strip_path: false
      plugins:
      - name: request-termination
        config:
          status_code: 401
          message: "Authentication required (Firebase auth not yet configured)"
      - name: rate-limiting
        config:
          minute: 60
          hour: 1000
      - name: response-transformer
        config:
          add:
            headers:
            - "X-Route-Type: api-protected"
            - "X-Service: catalog-bff"
    
    # Catalog BFF API routes - Optional auth
    - name: catalog-api-route
      service: catalog-bff-service
      hosts:
      - api.development.wapps.com
      paths:
      - /catalog
      strip_path: false
      plugins:
      - name: rate-limiting
        config:
          minute: 80
          hour: 1500
      - name: response-transformer
        config:
          add:
            headers:
            - "X-Route-Type: api"
            - "X-Service: catalog-bff"
    
    # Editorial Service
    - name: editorial-route
      service: aggregator-ssr-service
      hosts:
      - api.development.wapps.com
      paths:
      - /editorial
      strip_path: false
      plugins:
      - name: rate-limiting
        config:
          minute: 100
          hour: 2000
      - name: response-transformer
        config:
          add:
            headers:
            - "X-Route-Type: api"
            - "X-Service: editorial"
    
    # Auth Service
    - name: auth-service-route
      service: catalog-bff-service
      hosts:
      - api.development.wapps.com
      paths:
      - /auth
      strip_path: false
      plugins:
      - name: rate-limiting
        config:
          minute: 30
          hour: 500
      - name: response-transformer
        config:
          add:
            headers:
            - "X-Route-Type: auth"
            - "X-Service: auth"

    # Static routes
    - name: home-route
      service: cdn-service
      paths:
      - /
      plugins:
      - name: response-transformer
        config:
          add:
            headers:
            - "X-Route-Type: static"
              
    - name: categories-route
      service: cdn-service
      paths:
      - /categories
      plugins:
      - name: response-transformer
        config:
          add:
            headers:
            - "X-Route-Type: static"
    
    # Dynamic routes to SSR
    - name: api-route
      service: aggregator-ssr-service
      paths:
      - /api
      plugins:
      - name: response-transformer
        config:
          add:
            headers:
            - "X-Route-Type: dynamic"
    
    - name: search-route
      service: aggregator-ssr-service
      paths:
      - /search
      plugins:
      - name: response-transformer
        config:
          add:
            headers:
            - "X-Route-Type: dynamic"
    
    - name: app-route
      service: aggregator-ssr-service
      paths:
      - /app
      plugins:
      - name: response-transformer
        config:
          add:
            headers:
            - "X-Route-Type: dynamic"
    
    # Default fallback
    - name: default-route
      service: aggregator-ssr-service
      paths:
      - /
      plugins:
      - name: response-transformer
        config:
          add:
            headers:
            - "X-Route-Type: fallback"
    
    # Global plugins
    plugins:
    - name: rate-limiting
      config:
        minute: 100
        hour: 1000
        policy: local
        fault_tolerant: true
    - name: cors
      config:
        origins:
        - "*"
        methods:
        - GET
        - POST
        - PUT
        - PATCH
        - DELETE
        - OPTIONS
        headers:
        - Accept
        - Accept-Version
        - Authorization
        - Content-Length
        - Content-Type
        - Date
        - X-Auth-Token
        - X-Requested-With
        exposed_headers:
        - X-Auth-Token
        - X-Route-Type
        - X-Service
        credentials: true
        max_age: 3600
        preflight_continue: false
