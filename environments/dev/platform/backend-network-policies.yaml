# Network Policies for Backend Services

# These policies ensure backend services can only be accessed via ingress-nginx
# This provides a security layer even without a dedicated API gateway

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: catalog-bff-ingress-only
  namespace: catalog
  labels:
    app: catalog-bff
    security: ingress-controlled
spec:
  podSelector:
    matchLabels:
      app: catalog-bff
  policyTypes:
    - Ingress
  ingress:
    # Allow traffic from ingress-nginx
    - from:
      - namespaceSelector:
          matchLabels:
            app.kubernetes.io/name: ingress-nginx
      ports:
      - protocol: TCP
        port: 80
    
    # Allow traffic from same namespace (for internal communication, health checks)
    - from:
      - podSelector: {}
      ports:
      - protocol: TCP
        port: 80
    
    # Allow traffic from kube-system (for monitoring, health checks)
    - from:
      - namespaceSelector:
          matchLabels:
            kubernetes.io/metadata.name: kube-system
      ports:
      - protocol: TCP
        port: 80

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: editorial-ingress-only
  namespace: editorial
  labels:
    app: editorial
    security: ingress-controlled
spec:
  podSelector:
    matchLabels:
      app: editorial
  policyTypes:
    - Ingress
  ingress:
    # Allow traffic from ingress-nginx
    - from:
      - namespaceSelector:
          matchLabels:
            app.kubernetes.io/name: ingress-nginx
      ports:
      - protocol: TCP
        port: 1337
    
    # Allow traffic from same namespace
    - from:
      - podSelector: {}
      ports:
      - protocol: TCP
        port: 1337
    
    # Allow traffic from kube-system
    - from:
      - namespaceSelector:
          matchLabels:
            kubernetes.io/metadata.name: kube-system
      ports:
      - protocol: TCP
        port: 1337

---
# Note: Frontend applications (aggregator-csr, aggregator-ssr, etc.) 
# should remain publicly accessible via ingress-nginx
# They don't need restrictive network policies
